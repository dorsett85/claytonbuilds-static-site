---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface CarouselImage {
	src: ImageMetadata;
	alt: string;
}

interface Props {
	images: CarouselImage[];
}

const { images } = Astro.props;
---

<div class="relative w-full max-w-4xl mx-auto" data-carousel>
	<!-- Carousel Container -->
	<div class="relative overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-800" style="min-height: 500px;">
		<!-- Images -->
		{images.map((image, index) => (
			<div
				class={`carousel-slide absolute inset-0 transition-opacity duration-500 flex items-center justify-center ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
				data-slide={index}
			>
				<Image
					src={image.src}
					alt={image.alt}
					class="w-full h-auto max-h-[600px] object-contain"
					widths={[400, 600, 800, 1000]}
					sizes="(max-width: 768px) 100vw, (max-width: 1024px) 80vw, 800px"
					loading="lazy"
					decoding="async"
				/>
			</div>
		))}
	</div>

	<!-- Previous Button -->
	<button
		type="button"
		class="carousel-prev absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-900/80 hover:bg-white dark:hover:bg-gray-900 text-gray-900 dark:text-white p-3 rounded-full shadow-lg transition-all duration-200 hover:scale-110"
		aria-label="Previous image"
	>
		<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
		</svg>
	</button>

	<!-- Next Button -->
	<button
		type="button"
		class="carousel-next absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-900/80 hover:bg-white dark:hover:bg-gray-900 text-gray-900 dark:text-white p-3 rounded-full shadow-lg transition-all duration-200 hover:scale-110"
		aria-label="Next image"
	>
		<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
		</svg>
	</button>

	<!-- Indicators -->
	<div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
		{images.map((_, index) => (
			<button
				type="button"
				class={`carousel-indicator w-4 h-4 rounded-full transition-all duration-200 ${index === 0 ? 'bg-white dark:bg-gray-200 w-8' : 'bg-white/50 dark:bg-gray-400/50 hover:bg-white/75 dark:hover:bg-gray-300/75'}`}
				data-index={index}
				aria-label={`Go to image ${index + 1}`}
			>
			</button>
		))}
	</div>
</div>

<script>
	class ImageCarousel {
		private currentIndex = 0;
		private slides: NodeListOf<HTMLElement>;
		private indicators: NodeListOf<HTMLElement>;
		private prevBtn: HTMLElement | null;
		private nextBtn: HTMLElement | null;
		private totalSlides: number;
		private autoPlayInterval: number | null = null;

		constructor(private container: HTMLElement) {
			this.slides = container.querySelectorAll('.carousel-slide');
			this.indicators = container.querySelectorAll('.carousel-indicator');
			this.prevBtn = container.querySelector('.carousel-prev');
			this.nextBtn = container.querySelector('.carousel-next');
			this.totalSlides = this.slides.length;

			this.init();
		}

		private init() {
			// Previous button
			this.prevBtn?.addEventListener('click', () => {
				this.goToSlide(this.currentIndex - 1);
				this.resetAutoPlay();
			});

			// Next button
			this.nextBtn?.addEventListener('click', () => {
				this.goToSlide(this.currentIndex + 1);
				this.resetAutoPlay();
			});

			// Indicator buttons
			this.indicators.forEach((indicator, index) => {
				indicator.addEventListener('click', () => {
					this.goToSlide(index);
					this.resetAutoPlay();
				});
			});

			// Keyboard navigation
			this.container.addEventListener('keydown', (e) => {
				if (e.key === 'ArrowLeft') {
					this.goToSlide(this.currentIndex - 1);
					this.resetAutoPlay();
				} else if (e.key === 'ArrowRight') {
					this.goToSlide(this.currentIndex + 1);
					this.resetAutoPlay();
				}
			});

			// Touch swipe support
			let touchStartX = 0;
			let touchEndX = 0;

			this.container.addEventListener('touchstart', (e) => {
				touchStartX = e.changedTouches[0].screenX;
			});

			this.container.addEventListener('touchend', (e) => {
				touchEndX = e.changedTouches[0].screenX;
				this.handleSwipe();
			});

			const handleSwipe = () => {
				if (touchEndX < touchStartX - 50) {
					this.goToSlide(this.currentIndex + 1);
					this.resetAutoPlay();
				}
				if (touchEndX > touchStartX + 50) {
					this.goToSlide(this.currentIndex - 1);
					this.resetAutoPlay();
				}
			};

			this.handleSwipe = handleSwipe;

			// Auto play
			this.startAutoPlay();

			// Pause on hover
			this.container.addEventListener('mouseenter', () => this.stopAutoPlay());
			this.container.addEventListener('mouseleave', () => this.startAutoPlay());
		}

		private goToSlide(index: number) {
			// Wrap around
			if (index < 0) {
				index = this.totalSlides - 1;
			} else if (index >= this.totalSlides) {
				index = 0;
			}

			// Hide current slide
			this.slides[this.currentIndex]?.classList.remove('opacity-100');
			this.slides[this.currentIndex]?.classList.add('opacity-0');

			// Update current indicator
			this.indicators[this.currentIndex]?.classList.remove('bg-white', 'dark:bg-gray-200', 'w-8');
			this.indicators[this.currentIndex]?.classList.add('bg-white/50', 'dark:bg-gray-400/50');

			// Update index
			this.currentIndex = index;

			// Show new slide
			this.slides[this.currentIndex]?.classList.remove('opacity-0');
			this.slides[this.currentIndex]?.classList.add('opacity-100');

			// Update new indicator
			this.indicators[this.currentIndex]?.classList.add('bg-white', 'dark:bg-gray-200', 'w-8');
			this.indicators[this.currentIndex]?.classList.remove('bg-white/50', 'dark:bg-gray-400/50');
		}

		private startAutoPlay() {
			this.stopAutoPlay(); // Clear any existing interval first
			this.autoPlayInterval = window.setInterval(() => {
				this.goToSlide(this.currentIndex + 1);
			}, 5000); // Change slide every 5 seconds
		}

		private stopAutoPlay() {
			if (this.autoPlayInterval !== null) {
				clearInterval(this.autoPlayInterval);
				this.autoPlayInterval = null;
			}
		}

		private resetAutoPlay() {
			this.startAutoPlay(); // startAutoPlay now handles stopping first
		}

		private handleSwipe: () => void = () => {};
	}

	// Initialize carousel when component is visible
	document.addEventListener('DOMContentLoaded', () => {
		const carouselElements = document.querySelectorAll('[data-carousel]');
		carouselElements.forEach((element) => {
			new ImageCarousel(element as HTMLElement);
		});
	});
</script>
